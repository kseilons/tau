format long g

A=[0 0 1 0;0 0 0 1;0 -0.1134104046 0 0;0 6.615606936 0 0];
Ad = [
  1.0, -0.00131165, 0.1511355, -0.00006574791;
   0,    1.076513,         0,      0.1549708;
   0,  -0.0175753,       1.0,    -0.00131165;
   0,    1.025226,         0,       1.076513;
];

b=[0; 0; 0.00289017; -0.00192678];
bd = [
   0.000033126;
   -0.000021975;
   0.00043842;
  -0.00029444
];

Q = 1.0e+08 * [...
    0.000076144300000,                   0,                   0,                   0;...
                   0,                   0,                   0,                   0;...
                   0,                   0,   2.721821384350000,                   0;...
                   0,                   0,                   0,                   0];

Qd = 1.0e+08 * [...
    2.721897528650000,  -0.003570077018783,   0.411363835834429,  -0.000178954067414;
   -0.003570077018783,   0.000004682691522,  -0.000539565375272,   0.000000234725103;
    0.411363835834429,  -0.000539565375272,   0.062171679010754,  -0.000027046312456;
   -0.000178954067414,   0.000000234725103,  -0.000027046312456,   0.000000011765856];

lambda = eig(Q);
eighd = eig(Qd);
disp(lambda);
disp(eighd);

[S,J] = eig(Q)
Q_j = S*sqrtm(J)/S



[Sd,Jd] = eig(Qd)
Qd_j = Sd*sqrtm(Jd)/Sd


AQ = [Q_j', A'*Q_j', A'^2*Q_j', A'^3*Q_j']

AQd = [Qd_j', Ad'*Qd_j', Ad'^2*Qd_j', Ad'^3*Qd_j']

rank_AQ = rank(AQ)
rank_AQd = rank(AQd)

R = eye(1);

P = icare(A, b, Q, R)
P_d = dare(Ad, b, Q_d, R)

k_p = -R^-1 * b' * P
R_line = R + bd' * P_d * bd
k_p_d = -R_line^-1 * bd' * P_d * Ad

A_z = A + b * k_p
A_z_d = A_d + bd * k_p_d

lamda_A_z = eig(A_z)
lamda_A_z_d = eig(A_z_d)


